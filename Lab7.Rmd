---
title: "Lab 7: Spatial Statistics and Geographically Weighted Regression in Public Health"
---

\

# üè• Introduction

Welcome to your crash course in spatial statistics for public health! We're going to unravel patterns in space like map-based detectives ‚Äî think Sherlock Holmes meets epidemiology. We'll explore mapping, clustering, and how relationships between variables vary across geography. Buckle up!

\

# Load packages

As always, we need to load our packages. We have a couple of new friends joining us this week.

- **`spdep`**: This package handles spatial dependence ‚Äî creating neighborhood structures and calculating statistics like Moran's I and Local Indicators of Spatial Association (LISA). Think of it as your go-to for spatial autocorrelation.
- **`GWmodel`**: A robust package for running Geographically Weighted Regression (GWR), including model diagnostics, bandwidth selection, and mapping local coefficients. It‚Äôs the main engine behind spatially varying relationships.
- **`spgwr`**: A lighter package also used for GWR. In this tutorial, we use it mainly for its convenient `gwr.sel()` function to find the best adaptive bandwidth via cross-validation.

Together, these packages help us detect patterns, clusters, and relationships that change across space ‚Äî essential for spatial public health analysis.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
library(tidyverse)
library(tidycensus)
library(sf)
library(spdep)
library(GWmodel)
library(spgwr)
library(tmap)
```


\

# üì¶ Data Collection and Preparation

First, we need data. We'll grab county-level diabetes prevalence for 2021 from the CDC and merge it with county geometries and median household income from the American Community Survey 2021. For the diabetes data, I downloaded this from the [CDC US Diabetes Surveillance System](https://gis.cdc.gov/grasp/diabetes/diabetesatlas-surveillance.html#). It comes in a little ugly, so we will have to clean up the column names, reformat the FIPS codes, and filter to just California counties.

```{r load-data}
# Load and clean CDC diabetes CSV
diab_raw <- read_csv("/Users/pjames1/Dropbox/UC Davis Folders/SPH 215 GIS and Public Health/Github_Website/SPH215/DiabetesAtlas_CountyData.csv", skip = 2) |> 
  slice(1:(n() - 1))  # remove last row

# Clean column names
names(diab_raw) <- str_trim(names(diab_raw))

# Format FIPS codes with leading zeros
diab_raw <- diab_raw |> 
  mutate(CountyFIPS = str_pad(as.character(as.integer(CountyFIPS)), 5, pad = "0"))

# Filter for California counties only
ca_diabetes <- diab_raw |> 
  filter(str_starts(CountyFIPS, "06")) |> 
  mutate(Percentage = as.numeric(Percentage)) |> 
  select(FIPS = CountyFIPS, County, Diabetes = Percentage)
```

\

Now lets get our good ole median income data from the US Census. Because it's 2021 Diabetes data, we will pull the 2017-2021 five year estimates from the ACS.
```{r get-acs}
# Download median income and geometries for California counties
ca_geo <- get_acs(
  geography = "county",
  variables = c(income = "B19013_001"),  # Median household income
  state = "CA",
  geometry = TRUE,
  year = 2021
) %>%
  rename(income = estimate) %>%
  select(GEOID, NAME, income, geometry)
```

\

# üó∫Ô∏è Exploratory Mapping

Let's make a map and see what diabetes prevalence looks like across counties in California. 

```{r exploratory-mapping}
# Merge diabetes and ACS income data
ca_data <- ca_geo |> 
  left_join(ca_diabetes, by = c("GEOID" = "FIPS"))

tmap_mode("plot")
cat("\n### County-Level Diabetes Prevalence in California\n")
tm_shape(ca_data) +
  tm_polygons("Diabetes", palette = "Reds", style = "quantile",
              title = "% Diagnosed Diabetes")
```

\

# üß≠ Spatial Autocorrelation

Now let‚Äôs ask: are diabetes rates clustered in space, or scattered randomly like confetti in a strong breeze? This is where spatial autocorrelation steps in. We'll start with Moran‚Äôs I ‚Äî the granddaddy of spatial pattern detection.

\

## Global Moran‚Äôs I

Moran‚Äôs I is a measure of overall spatial autocorrelation ‚Äî that is, how similar or dissimilar values (like diabetes prevalence) are in nearby areas (i.e., in nearby counties). 

- Values close to **+1** mean strong positive spatial autocorrelation ‚Äî high values cluster with other high values, and low with low (think: like attracts like).
- Values near **0** mean no spatial pattern ‚Äî just noise.
- Values near **-1** mean high and low values are actively repelling each other (rare in public health).

Let's calculate Moran‚Äôs I and find out if diabetes prevalence in California follows any spatial logic.

```{r morans-i}
nb <- poly2nb(ca_data)
lw <- nb2listw(nb, style = "W")
moran.test(ca_data$Diabetes, lw)
```

**How to read this:**

- A **Moran‚Äôs I value of 0.30** means moderate positive spatial autocorrelation ‚Äî counties with similar diabetes rates are near each other.
- A **p-value < 0.001** tells us this clustering is **statistically significant** ‚Äî not random.
- The **standard deviate (3.76)** is like a z-score; it's far enough from zero to support strong evidence of spatial patterning.

üëâ **Bottom line:** Diabetes rates aren‚Äôt randomly distributed across California. There are clusters of high and low values, and we‚Äôve got statistical proof! This result tells us that there is statistically significant spatial clustering of diabetes prevalence across California counties. Counties with high diabetes rates tend to be near other high-rate counties, and the same is true for low-rate counties. The Moran‚Äôs I value of ~0.30 indicates moderate positive spatial autocorrelation, and the tiny p-value confirms that this pattern is not due to chance.

\

## Local Moran‚Äôs I (LISA)

While Moran‚Äôs I tells us whether there's spatial autocorrelation in general, LISA zooms in and tells us **where** it's happening. 

LISA stands for Local Indicators of Spatial Association, and it helps us detect:
- **High-High clusters**: High diabetes rates surrounded by other high-rate counties (hot clusters).
- **Low-Low clusters**: Healthy zones with low diabetes prevalence.
- **High-Low or Low-High outliers**: Counties that buck the trend ‚Äî like a donut hole in a cake.

Mapping LISA helps target interventions more precisely, and explain those spatial oddballs.

```{r lisa}
local_moran <- localmoran(ca_data$Diabetes, lw)
ca_data$Ii <- local_moran[, "Ii"]
ca_data$Pval <- local_moran[, "Pr(z != E(Ii))"]

# Map LISA
cat("\n### Local Spatial Clustering of Diabetes\n")
tm_shape(ca_data) +
  tm_polygons("Ii", style = "quantile", palette = "PuOr", title = "Local Moran's I")
```

\

### üó∫Ô∏è Interpreting the LISA Map

This map shows where spatial clustering of diabetes is strongest ‚Äî not just overall, but **locally**. Here's how to read it:

- **Dark purple counties** have strong local clustering ‚Äî likely high-high or low-low patterns. These are areas where diabetes rates mirror their neighbors and form significant clusters.
- **Orange or tan counties** may be spatial **outliers** ‚Äî places where diabetes rates differ from nearby counties. For example, a healthy county surrounded by high-rate neighbors.
- **Gray or muted tones** indicate weak or non-significant clustering.
- **White areas** may represent missing or insignificant data.

üëâ **In practice:** Counties with strong clustering (dark purple) may benefit from regional strategies, while outliers may need more localized investigation. This helps tailor public health interventions to spatial realities.

\

## üî• Hot Spot Analysis (Gi*)

Now we spice things up with the Getis-Ord Gi* statistic ‚Äî pronounced "gee-star." This method identifies **statistically significant hot and cold spots** in the data.

- A **hot spot** is a county with a high value (e.g., diabetes rate) surrounded by other high-value neighbors.
- A **cold spot** is the opposite: a low-value county in a sea of low values.

Gi* doesn't just look at one value ‚Äî it considers the neighborhood around it too. This is powerful for public health mapping, especially when prioritizing interventions or allocating resources. **hot** and **cold** spots ‚Äî areas with significantly higher or lower rates than expected.

```{r gi-star}
gi_star <- localG(ca_data$Diabetes, lw)
ca_data$Gi_star <- as.numeric(gi_star)

cat("\n### Hot and Cold Spots of Diabetes\n")
tm_shape(ca_data) +
  tm_polygons("Gi_star", palette = "RdBu", style = "pretty", title = "Gi* Hot Spots")
```

### üî• Interpreting the Gi* Map

This map uses the Getis-Ord Gi* statistic to highlight **statistically significant spatial clusters** of diabetes ‚Äî also known as hot and cold spots:

- **Dark blue counties** (Gi* > 2) are **hot spots**: areas with high diabetes prevalence that are also surrounded by other high-prevalence counties. These are prime targets for regional public health efforts.
- **Dark red counties** (Gi* < -2) are **cold spots**: clusters of lower-than-average diabetes rates. Great for understanding what‚Äôs going right.
- **Lighter shades** (e.g., peach or sky blue) represent less intense clustering ‚Äî not as statistically extreme.

üëâ **In practice:** The blue-hot lower half of the state (e.g., San Bernardino, Imperial, Tulare) may benefit from coordinated, regional interventions, while red-cold northern counties may offer models of prevention or service delivery worth emulating.

\

# üìâ Geographically Weighted Regression (GWR)

GWR ‚Äî Geographically Weighted Regression ‚Äî is like regular regression but with a twist: the coefficients can change depending on **where** you are.

Traditional regression assumes one-size-fits-all relationships. But in public health, the impact of income on diabetes may differ from San Francisco to Fresno.

GWR fits a separate regression model--no more assuming one relationship is consistent across all areas in your analysis!

```{r gwr}
coords <- st_coordinates(st_centroid(ca_data))
ca_data$X <- coords[, 1]
ca_data$Y <- coords[, 2]

bw <- gwr.sel(Diabetes ~ income, data = ca_data, coords = coords, adapt = TRUE)

# Run GWR using adaptive bandwidth
model <- gwr(Diabetes ~ income, data = ca_data, coords = coords, 
             adapt = bw, hatmatrix = TRUE)

ca_data$gwr_income <- model$SDF$income
```

\

üìå INTERPRETATION:
The output shows the model testing different 'adaptive q' values, which represent the proportion of neighboring counties used in each local model. It chooses the q value with the lowest cross-validation (CV) score ‚Äî best predictive fit. For example: q = 0.082 means ~8% of counties (‚âà5 counties) are used in each local regression. Lower CV = better model. It's finding the 'just right' neighborhood size for each regression.

\

## üóæ Map Local GWR Coefficients

Let‚Äôs map those locally varying regression coefficients and see where income matters more (or less) for diabetes.

```{r gwr-map}
tm_shape(ca_data) +
  tm_polygons("gwr_income", palette = "RdYlGn", style = "quantile", title = "GWR: Income Effect")
```

\

#### üß© Interpreting the GWR Map

This map shows how the relationship between income and diabetes **varies across California** ‚Äî it's a spatial view of the regression coefficient between income and diabetes.

- All the values are **negative**, meaning higher income is associated with **lower diabetes prevalence** ‚Äî but **how strongly** this is true varies across space.

- **Dark red counties** (most negative values): These are the places where income has the **strongest inverse relationship** with diabetes. In other words, improving economic conditions here could have a **big public health payoff**.

- **Lighter yellow to green counties**: These areas still show a negative relationship, but it's **weaker**. That might mean other social or environmental factors are playing a bigger role in these counties.

- **Dark green areas**: The weakest negative associations ‚Äî here, income might matter less for diabetes prevention, or other factors dominate.

üëâ **In practice:** This map helps public health professionals tailor interventions. In counties where income is a strong driver of diabetes, economic support programs might reduce prevalence. In others, different strategies may be needed.

\

# üß† Take home

- **Moran's I**: Measures overall spatial autocorrelation (think: is there a pattern?).
- **LISA/Gi***: Reveal local clusters and hot/cold spots (where‚Äôs the action?).
- **GWR**: Shows where the income-diabetes relationship is strong, weak, or flipping direction.

# ‚úÖ Summary

Boom! You just crunched real public health data using cutting-edge spatial tools. From maps to models, you've uncovered spatial inequalities in health. Go forth and map responsibly!
